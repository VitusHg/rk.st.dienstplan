const ICS_URL_KEY = 'ics_url';

// Speichert die ICS-URL lokal
function saveICSUrl(url) {
    localStorage.setItem(ICS_URL_KEY, url);
}

// Holt die gespeicherte ICS-URL
function getICSUrl() {
    return localStorage.getItem(ICS_URL_KEY);
}

// LÃ¤dt die ICS-Datei und parst sie
async function fetchICSData() {
    const icsUrl = getICSUrl();
    if (!icsUrl) {
        alert('Bitte zuerst eine ICS-URL eingeben.');
        return;
    }

    try {
        const response = await fetch(icsUrl);
        if (!response.ok) throw new Error('ICS-Datei konnte nicht geladen werden.');
        const text = await response.text();
        parseICS(text);
    } catch (error) {
        console.error('Fehler beim Laden der ICS-Datei:', error);
        alert('Fehler beim Laden der ICS-Datei.');
    }
}

// Einfache ICS-Parser-Funktion
function parseICS(icsText) {
    const events = [];
    const eventBlocks = icsText.split('BEGIN:VEVENT').slice(1);

    eventBlocks.forEach(block => {
        const summary = block.match(/SUMMARY:(.*)/)?.[1] || 'Unbekannter Dienst';
        const description = block.match(/DESCRIPTION:(.*)/)?.[1] || '';
        const location = block.match(/LOCATION:(.*)/)?.[1] || 'Unbekannter Ort';
        const dtStart = block.match(/DTSTART:(\d{8}T\d{6})/)?.[1] || '';
        const dtEnd = block.match(/DTEND:(\d{8}T\d{6})/)?.[1] || '';
        
        events.push({ summary, description, location, dtStart, dtEnd });
    });

    renderEvents(events);
}

// Zeigt die Termine visuell an
function renderEvents(events) {
    const container = document.getElementById('event-list');
    container.innerHTML = '';
    events.forEach(event => {
        const eventEl = document.createElement('div');
        eventEl.className = 'event';
        eventEl.innerHTML = `
            <h3>${event.summary}</h3>
            <p><strong>Zeit:</strong> ${formatDate(event.dtStart)} - ${formatDate(event.dtEnd)}</p>
            <p><strong>Ort:</strong> ${event.location}</p>
            <p><strong>Kollegen:</strong> ${event.description}</p>
        `;
        container.appendChild(eventEl);
    });
}

// Formatiert das Datum lesbar
function formatDate(icsDate) {
    if (!icsDate) return 'Unbekannt';
    const year = icsDate.substring(0, 4);
    const month = icsDate.substring(4, 6);
    const day = icsDate.substring(6, 8);
    const hour = icsDate.substring(9, 11);
    const minute = icsDate.substring(11, 13);
    return `${day}.${month}.${year} ${hour}:${minute} Uhr`;
}

// Initialisierung der App
window.onload = function () {
    document.getElementById('save-url').addEventListener('click', () => {
        const url = document.getElementById('ics-url').value;
        saveICSUrl(url);
    });

    document.getElementById('refresh').addEventListener('click', fetchICSData);
    fetchICSData();
};
